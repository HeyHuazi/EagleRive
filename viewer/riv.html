<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rive 查看器</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #F0F2F5;
            --bg-hover: #F7F8FA;
            --text-primary: #19213D;
            --text-secondary: #6B7280;
            --text-tertiary: #BAC0CC;
            --border: #F0F2F5;
            --accent: #2388FF;
            --accent-hover: #1a6fdb;
            --accent-bg: rgba(35,136,255,0.08);
            --accent-text: #2388FF;
            --green: #4cd964;
            --green-hover: #3cbf56;
            --canvas-bg: #F7F8FA;
            --card-bg: #ffffff;
            --card-border: #F0F2F5;
            --checkerboard-1: #f0f0f4;
            --checkerboard-2: #e4e4ea;
            /* Flat shadows */
            --shadow-raised: 0px 2px 4px rgba(25,33,61,0.08);
            --shadow-raised-sm: 0px 1px 3px rgba(25,33,61,0.10);
            --shadow-inset: inset 0 1px 2px rgba(25,33,61,0.06);
            --shadow-inset-sm: none;
        }
        .dark-theme {
            --bg-primary: #1a1a22;
            --bg-secondary: #1a1a22;
            --bg-tertiary: #222230;
            --bg-hover: #26263a;
            --text-primary: #e8e8f0;
            --text-secondary: #8888a0;
            --text-tertiary: #55556a;
            --border: #2a2a3a;
            --accent-bg: rgba(35,136,255,0.12);
            --canvas-bg: #1a1a22;
            --card-bg: #1e1e2a;
            --card-border: #2a2a3a;
            --checkerboard-1: #151520;
            --checkerboard-2: #1e1e2a;
            --shadow-raised: 0px 2px 4px rgba(0,0,0,0.30);
            --shadow-raised-sm: 0px 1px 3px rgba(0,0,0,0.25);
            --shadow-inset: inset 0 1px 2px rgba(0,0,0,0.20);
            --shadow-inset-sm: none;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', system-ui, sans-serif;
            background: var(--bg-primary); color: var(--text-primary);
            height: 100vh; display: flex; overflow: hidden;
        }

        /* ===== Main Grid ===== */
        .main { flex: 1; display: grid; grid-template-columns: 1fr 380px; overflow: hidden; }

        /* ===== Canvas Area ===== */
        .canvas-area {
            display: flex; flex-direction: column; overflow: hidden;
            padding: 12px; padding-right: 0;
        }
        .canvas-container {
            flex: 1; position: relative; overflow: hidden;
            background: var(--canvas-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .canvas-container.bg-white { background: #ffffff; }
        .canvas-container.bg-black { background: #000000; }
        .canvas-container.bg-checker {
            background-image:
                linear-gradient(45deg, var(--checkerboard-2) 25%, transparent 25%),
                linear-gradient(-45deg, var(--checkerboard-2) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, var(--checkerboard-2) 75%),
                linear-gradient(-45deg, transparent 75%, var(--checkerboard-2) 75%);
            background-size: 16px 16px;
            background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
            background-color: var(--checkerboard-1);
        }
        #riveCanvas { display: block; width: 100%; height: 100%; }

        .overlay {
            position: absolute; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: var(--canvas-bg); z-index: 10; transition: opacity 0.3s;
            border-radius: 12px;
        }
        .overlay.hidden { opacity: 0; pointer-events: none; }
        .spinner {
            width: 28px; height: 28px; border: 2.5px solid var(--bg-tertiary);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: var(--text-secondary); font-size: 13px; margin-top: 12px; }

        /* Rev file notice */
        .rev-notice {
            display: flex; flex-direction: column; align-items: center; gap: 14px;
            padding: 36px; text-align: center;
        }
        .rev-badge {
            display: inline-block; padding: 6px 18px; border-radius: 24px;
            background: #f59e0b; color: #fff; font-size: 14px; font-weight: 700;
            letter-spacing: 0.5px; box-shadow: 0 3px 10px rgba(245,158,11,0.25);
        }
        .rev-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .rev-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.7; max-width: 360px; }
        .rev-link {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 8px 20px; border-radius: 8px;
            background: var(--accent); color: #fff; text-decoration: none;
            font-size: 13px; font-weight: 500; margin-top: 4px;
            transition: all 0.15s;
        }
        .rev-link:hover { background: var(--accent-hover); transform: translateY(-1px); }

        /* ===== Sidebar ===== */
        .sidebar {
            background: var(--card-bg);
            display: flex; flex-direction: column; overflow: hidden;
            padding: 12px; padding-left: 8px;
        }
        .sidebar-inner {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            background: var(--card-bg); border-radius: 12px;
            border: 1px solid var(--border);
        }

        /* ===== File Info (permanent, above tabs) ===== */
        .file-info {
            padding: 20px 16px; flex-shrink: 0;
            display: flex; flex-direction: column; gap: 12px;
        }
        .info-row {
            display: flex; gap: 36px;
        }
        .info-item {
            display: flex; flex-direction: column; gap: 6px;
            flex: 1; min-width: 0;
        }
        .info-label {
            font-size: 14px; line-height: 18px; color: var(--text-tertiary);
        }
        .info-value {
            font-size: 14px; line-height: 18px; font-weight: 500; color: var(--text-primary);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        /* Background swatches */
        .bg-swatches { display: flex; gap: 6px; }
        .bg-swatch {
            width: 58px; height: 27px; border-radius: 4px; cursor: pointer;
            border: 1px solid var(--border); transition: all 0.15s;
            overflow: hidden; flex-shrink: 0;
        }
        .bg-swatch:hover { opacity: 0.8; }
        .bg-swatch.active { outline: 2px solid var(--accent); outline-offset: 1px; }
        .bg-swatch-white { background: #fff; }
        .bg-swatch-black { background: #000; border-color: transparent; }
        .bg-swatch-checker {
            background-image: linear-gradient(45deg, #bbb 25%, transparent 25%),
                linear-gradient(-45deg, #bbb 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #bbb 75%),
                linear-gradient(-45deg, transparent 75%, #bbb 75%);
            background-size: 6px 6px;
            background-position: 0 0, 0 3px, 3px -3px, -3px 0px;
            background-color: #999;
        }

        /* ===== Sidebar Tabs ===== */
        .sidebar-tabs {
            display: flex; flex-shrink: 0; padding: 4px; gap: 2px;
            background: var(--bg-tertiary); border-radius: 8px; margin: 0 16px;
        }
        .sidebar-tab {
            flex: 1; padding: 8px 0; border: none; background: none;
            font-size: 14px; font-weight: 500; color: var(--text-secondary);
            cursor: pointer; border-radius: 6px; transition: all 0.15s;
        }
        .sidebar-tab:hover { color: var(--text-primary); }
        .sidebar-tab.active {
            color: var(--text-primary); font-weight: 600;
            background: var(--card-bg);
            outline: 1px solid var(--border);
            box-shadow: var(--shadow-raised-sm);
        }

        /* ===== Sidebar Body ===== */
        .sidebar-body { flex: 1; overflow-y: auto; padding: 16px; }
        .sidebar-body::-webkit-scrollbar { width: 4px; }
        .sidebar-body::-webkit-scrollbar-track { background: transparent; }
        .sidebar-body::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
        .sidebar-body::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }
        .panel { display: none; }
        .panel.active { display: block; }

        .section { margin-bottom: 16px; }
        #vmSection { padding-top: 16px; border-top: 1px solid var(--border); }

        /* ===== Playback Controls ===== */
        .playback-row { display: flex; gap: 8px; margin-bottom: 16px; }
        .btn-playback {
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px;
            padding: 8px 16px; border: 1px solid var(--border); border-radius: 4px;
            background: var(--card-bg); color: var(--text-primary);
            font-size: 14px; font-weight: 500; cursor: pointer;
            box-shadow: var(--shadow-raised-sm);
            transition: all 0.15s;
        }
        .btn-playback:hover { background: var(--bg-hover); }
        .btn-playback:active { background: var(--bg-tertiary); }
        .btn-playback .ico { width: 14px; height: 14px; }

        /* ===== List items ===== */
        .item {
            padding: 8px 12px; border-radius: 8px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: all 0.12s; margin-bottom: 3px;
        }
        .item:hover { background: var(--bg-hover); }
        .item.active {
            background: var(--accent-bg); color: var(--accent-text); font-weight: 500;
        }

        /* ===== Select ===== */
        .sel {
            width: 100%; padding: 8px 12px; border: 1px solid var(--border);
            border-radius: 8px; background: var(--card-bg); color: var(--text-primary);
            font-size: 13px; cursor: pointer;
            box-shadow: var(--shadow-raised-sm);
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='14' height='14' viewBox='0 0 14 14' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10.848 5.977L6.998 10.123L3.148 5.977' stroke='%23ACB4C0' stroke-width='1.3' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 30px;
        }
        .sel:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-bg); }

        /* ===== Input cards ===== */
        .icard {
            padding: 10px 12px; background: var(--card-bg); border-radius: 10px;
            margin-bottom: 6px; border: 1px solid var(--border);
        }
        .icard-label { font-size: 12px; font-weight: 500; margin-bottom: 6px; display: block; color: var(--text-secondary); }

        /* Trigger grid */
        .trigger-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .trigger-btn {
            height: 32px; padding: 0 12px; border: none; border-radius: 8px;
            background: var(--accent); color: #fff; font-size: 12px; font-weight: 500;
            cursor: pointer; transition: all 0.15s; width: 100%;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .trigger-btn:hover { background: var(--accent-hover); }
        .trigger-btn:active { transform: scale(0.97); }

        /* Switch - clean toggle */
        .sw-row { display: flex; align-items: center; justify-content: space-between; }
        .sw { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
        .sw input { opacity: 0; width: 0; height: 0; }
        .sw-track {
            position: absolute; inset: 0; background: var(--bg-tertiary);
            border-radius: 24px; transition: 0.25s; cursor: pointer;
        }
        .sw-track::before {
            content: ''; position: absolute; width: 18px; height: 18px;
            left: 3px; top: 3px; background: #fff; border-radius: 50%; transition: 0.25s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.10);
        }
        .sw input:checked + .sw-track { background: var(--green); }
        .sw input:checked + .sw-track::before { transform: translateX(20px); }

        /* Number input */
        .ninput {
            width: 100%; height: 32px; padding: 0 10px; border: 1px solid var(--border);
            border-radius: 8px; background: var(--card-bg); color: var(--text-primary);
            font-size: 13px;
        }
        .ninput:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-bg); }

        /* SM input type group */
        .sm-type-group { margin-top: 12px; }
        .sm-type-group:first-child { margin-top: 8px; }
        .sm-type-hd {
            font-size: 11px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.4px; color: var(--text-secondary); margin-bottom: 8px;
            display: flex; align-items: center; gap: 6px;
        }
        .sm-type-badge {
            font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 6px;
            background: var(--bg-tertiary); color: var(--text-tertiary);
            letter-spacing: 0.3px;
        }

        .empty { color: var(--text-tertiary); font-size: 12px; padding: 24px 0; text-align: center; }

        /* ===== ViewModel property controls ===== */
        .sinput {
            width: 100%; height: 32px; padding: 0 10px; border: 1px solid var(--border);
            border-radius: 8px; background: var(--card-bg); color: var(--text-primary);
            font-size: 13px;
        }
        .sinput:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-bg); }
        .color-row { display: flex; align-items: center; gap: 10px; }
        .color-swatch {
            width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border);
            cursor: pointer; flex-shrink: 0; position: relative; overflow: hidden;
        }
        .color-swatch input[type="color"] {
            position: absolute; inset: -4px; width: calc(100% + 8px); height: calc(100% + 8px);
            border: none; padding: 0; cursor: pointer; opacity: 0;
        }
        .color-hex { font-size: 12px; color: var(--text-secondary); font-family: 'SF Mono', 'Menlo', monospace; }

        /* Nested ViewModel container */
        .vm-nested { margin-top: 8px; padding-left: 12px; border-left: 2px solid var(--border); }

        /* SVG icons inline */
        .ico { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    </style>
</head>
<body>
    <!-- Main -->
    <div class="main">
        <!-- Canvas area -->
        <div class="canvas-area">
            <div class="canvas-container bg-checker" id="canvasContainer">
                <canvas id="riveCanvas"></canvas>
                <div class="overlay" id="overlay"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-inner">
                <!-- File info (always visible above tabs) -->
                <div class="file-info" id="fileInfo">
                    <div class="info-row">
                        <div class="info-item">
                            <span class="info-label">文件</span>
                            <span class="info-value" id="fileName">加载中...</span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-item">
                            <span class="info-label">尺寸</span>
                            <span class="info-value" id="infoDims">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">动画</span>
                            <span class="info-value" id="infoAnimCount">-</span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-item">
                            <span class="info-label">状态机</span>
                            <span class="info-value" id="infoSMCount">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">视图模型</span>
                            <span class="info-value" id="infoVMCount">-</span>
                        </div>
                    </div>
                    <div class="info-row" id="artboardRow" style="display:none">
                        <div class="info-item">
                            <span class="info-label">画板</span>
                            <select class="sel" id="artboardSelect"></select>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-item">
                            <span class="info-label">背景</span>
                            <div class="bg-swatches">
                                <div class="bg-swatch bg-swatch-white" data-bg="white" title="白色"></div>
                                <div class="bg-swatch bg-swatch-black" data-bg="black" title="黑色"></div>
                                <div class="bg-swatch bg-swatch-checker active" data-bg="checker" title="透明"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="statemachine">状态机</button>
                    <button class="sidebar-tab" data-tab="timeline">时间线</button>
                </div>

                <!-- Tab content -->
                <div class="sidebar-body">
                    <!-- 状态机 + Data Binding -->
                    <div class="panel active" id="panel-statemachine">
                        <div class="section" id="smSection">
                            <select class="sel" id="smSelect"><option value="">选择...</option></select>
                            <div id="smInputs" style="display:none; margin-top:8px"></div>
                        </div>
                        <!-- Data Binding（状态机下方） -->
                        <div class="section" id="vmSection" style="display:none">
                            <div class="sm-type-hd" style="margin-bottom:8px">Data Binding</div>
                            <select class="sel" id="vmSelect"><option value="">无视图模型</option></select>
                            <div id="vmProps" style="margin-top:8px"></div>
                        </div>
                    </div>
                    <!-- 时间线 -->
                    <div class="panel" id="panel-timeline">
                        <div class="playback-row">
                            <button class="btn-playback" id="btnPlay" title="空格键 播放/暂停">
                                <svg class="ico" id="icoPlay" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                                <span id="playLabel">暂停</span>
                            </button>
                            <button class="btn-playback" id="btnRestart" title="R 键重新开始">
                                <svg class="ico" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                                <span>重新播放</span>
                            </button>
                        </div>
                        <div id="animList"><div class="empty">加载中...</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@rive-app/webgl2@2.35.0"></script>
    <script>
    (function () {
        /* ====== Params ====== */
        const params = new URLSearchParams(location.search);
        const filePath = params.get('path');
        const theme = params.get('theme') || 'light';
        if (theme === 'dark') document.body.classList.add('dark-theme');

        /* ====== Refs ====== */
        const canvas = document.getElementById('riveCanvas');
        const overlay = document.getElementById('overlay');
        const container = document.getElementById('canvasContainer');
        const btnPlay = document.getElementById('btnPlay');
        const btnRestart = document.getElementById('btnRestart');
        const playLabel = document.getElementById('playLabel');
        const icoPlay = document.getElementById('icoPlay');

        let R = null;  // rive instance
        let playing = true;
        let curAnim = null;
        let curSM = null;

        /* ====== Default Layout ====== */
        const defaultLayout = new rive.Layout({ fit: rive.Fit.Contain, alignment: rive.Alignment.Center });

        /* ====== Canvas sizing ====== */
        function fitCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            if (R) R.resizeDrawingSurfaceToCanvas();
        }

        /* ====== Play/Pause icon ====== */
        function updatePlayIcon() {
            if (playing) {
                icoPlay.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
                playLabel.textContent = '暂停';
            } else {
                icoPlay.innerHTML = '<polygon points="6,4 20,12 6,20"/>';
                playLabel.textContent = '播放';
            }
        }

        /* ====== Tab switching ====== */
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
                // 切换到状态机标签时，如有状态机则播放
                if (tab.dataset.tab === 'statemachine' && curSM) playSM(curSM);
                else if (tab.dataset.tab === 'timeline' && curAnim) playAnim(curAnim);
            });
        });

        /* ====== Background ====== */
        document.querySelectorAll('.bg-swatch').forEach(swatch => {
            swatch.addEventListener('click', () => {
                document.querySelectorAll('.bg-swatch').forEach(s => s.classList.remove('active'));
                swatch.classList.add('active');
                container.className = 'canvas-container';
                const bg = swatch.dataset.bg;
                if (bg === 'checker') container.classList.add('bg-checker');
                else if (bg === 'white') container.classList.add('bg-white');
                else if (bg === 'black') container.classList.add('bg-black');
            });
        });

        /* ====== Init Rive ====== */
        function initRive() {
            if (!filePath) { showError('未指定文件路径'); return; }

            // 检测 .rev 文件（编辑器备份格式，运行时无法加载）
            const ext = filePath.split('.').pop().toLowerCase();
            if (ext === 'rev') {
                showRevNotice();
                return;
            }

            fitCanvas();

            R = new rive.Rive({
                src: filePath,
                canvas: canvas,
                autoplay: false,
                autoBind: true,
                layout: defaultLayout,
                onLoad: () => {
                    overlay.classList.add('hidden');
                    R.resizeDrawingSurfaceToCanvas();
                    populateUI();
                    // populateSMs/populateAnims 会负责播放，
                    // 如果没有状态机也没有动画，则手动启动播放
                    if (!curSM && !curAnim) R.play();
                },
                onLoadError: () => showError('Rive 文件加载失败'),
            });
        }

        function showError(msg) {
            overlay.innerHTML = '<div class="error-msg">' + msg + '</div>';
        }

        function showRevNotice() {
            const fileName = filePath.split('/').pop().split('\\').pop();
            document.getElementById('fileName').textContent = fileName;
            // 隐藏播放控制和时间线标签
            var timelineTab = document.querySelector('.sidebar-tab[data-tab="timeline"]');
            if (timelineTab) timelineTab.style.display = 'none';

            overlay.innerHTML =
                '<div class="rev-notice">' +
                    '<span class="rev-badge">.REV 文件</span>' +
                    '<div class="rev-title">Rive 编辑器备份文件</div>' +
                    '<div class="rev-desc">' +
                        '这是 Rive 编辑器备份文件（.rev），包含完整的编辑项目数据。' +
                        'Rive 运行时无法预览此文件。<br><br>' +
                        '如需预览动画，请在 Rive 编辑器中打开并导出 .riv（运行时）文件。' +
                    '</div>' +
                    '<a class="rev-link" href="https://editor.rive.app/" target="_blank">打开 Rive 编辑器</a>' +
                '</div>';
        }

        /* ====== Populate UI ====== */
        function populateUI() {
            const fileName = filePath.split('/').pop().split('\\').pop();
            document.getElementById('fileName').textContent = fileName;

            const b = R.bounds;
            const w = b ? Math.round(b.maxX - b.minX) : 0;
            const h = b ? Math.round(b.maxY - b.minY) : 0;

            // Artboards
            const abs = R.artboardNames || [];
            if (abs.length > 1) {
                document.getElementById('artboardRow').style.display = '';
                const sel = document.getElementById('artboardSelect');
                sel.innerHTML = abs.map(a => '<option value="' + a + '">' + a + '</option>').join('');
                sel.addEventListener('change', () => switchArtboard(sel.value));
            }

            try { populateAnims(); } catch (e) { console.error('[Rive] populateAnims error:', e); }
            try { populateSMs(); } catch (e) { console.error('[Rive] populateSMs error:', e); }
            try { populateViewModel(); } catch (e) { console.error('[Rive] populateViewModel error:', e); }
            try { populateFileInfo(w, h, abs); } catch (e) { console.error('[Rive] populateFileInfo error:', e); }
        }

        /* ====== Populate file info (above tabs) ====== */
        function populateFileInfo(w, h, abs) {
            const anims = R.animationNames || [];
            const sms = R.stateMachineNames || [];
            var vmCount = 0;
            try { vmCount = R.viewModelCount || 0; } catch (e) {}

            document.getElementById('infoDims').textContent = w && h ? w + ' \u00d7 ' + h : '-';
            document.getElementById('infoAnimCount').textContent = anims.length || '-';
            document.getElementById('infoSMCount').textContent = sms.length || '-';
            document.getElementById('infoVMCount').textContent = vmCount || '-';
        }

        /* ====== Artboard switch ====== */
        function switchArtboard(name) {
            if (R) R.cleanup();
            curAnim = null; curSM = null;
            R = new rive.Rive({
                src: filePath, canvas: canvas, artboard: name, autoplay: false,
                autoBind: true,
                layout: defaultLayout,
                onLoad: () => {
                    R.resizeDrawingSurfaceToCanvas();
                    try { populateAnims(); } catch (e) { console.error('[Rive] switchArtboard populateAnims error:', e); }
                    try { populateSMs(); } catch (e) { console.error('[Rive] switchArtboard populateSMs error:', e); }
                    try { populateViewModel(); } catch (e) { console.error('[Rive] switchArtboard populateViewModel error:', e); }
                    if (!curSM && !curAnim) R.play();
                },
            });
            playing = true; updatePlayIcon();
        }

        /* ====== Animations ====== */
        function populateAnims() {
            const anims = R.animationNames || [];
            const list = document.getElementById('animList');
            if (!anims.length) { list.innerHTML = '<div class="empty">暂无动画</div>'; return; }

            curAnim = anims[0];
            list.innerHTML = anims.map((a, i) =>
                '<div class="item' + (i === 0 ? ' active' : '') + '" data-anim="' + a + '">' + a + '</div>'
            ).join('');

            list.querySelectorAll('.item').forEach(el => {
                el.addEventListener('click', () => {
                    list.querySelectorAll('.item').forEach(x => x.classList.remove('active'));
                    el.classList.add('active');
                    if (curAnim) R.stop(curAnim);
                    curAnim = el.dataset.anim;
                    R.play(curAnim);
                    playing = true; updatePlayIcon();
                });
            });
        }

        /* ====== State Machines ====== */
        function populateSMs() {
            const sms = R.stateMachineNames || [];
            document.getElementById('smSection').style.display = sms.length ? '' : 'none';
            const sel = document.getElementById('smSelect');
            sel.innerHTML = sms.length
                ? sms.map(s => '<option value="' + s + '">' + s + '</option>').join('')
                : '<option value="">暂无状态机</option>';
            sel.onchange = () => {
                if (sel.value) {
                    playSM(sel.value);
                    // 延迟获取 Inputs，等 SM 初始化完成
                    requestAnimationFrame(() => requestAnimationFrame(() => loadSMInputs(sel.value)));
                }
            };
            if (sms.length) {
                playSM(sms[0]);
                // 延迟获取 Inputs，等 SM 初始化完成
                requestAnimationFrame(() => requestAnimationFrame(() => loadSMInputs(sms[0])));
            }
        }

        function loadSMInputs(name) {
            const inputs = R.stateMachineInputs(name);
            const box = document.getElementById('smInputs');
            if (!inputs || !inputs.length) { box.style.display = 'none'; return; }
            box.style.display = '';

            // Group by type
            const triggers = inputs.filter(i => i.type === rive.StateMachineInputType.Trigger);
            const bools = inputs.filter(i => i.type === rive.StateMachineInputType.Boolean);
            const nums = inputs.filter(i => i.type === rive.StateMachineInputType.Number);

            let html = '';

            if (triggers.length) {
                html += '<div class="sm-type-group"><div class="sm-type-hd">触发器 <span class="sm-type-badge">' + triggers.length + '</span></div><div class="trigger-grid">';
                triggers.forEach(t => { html += '<button class="trigger-btn" data-trg="' + t.name + '">' + t.name + '</button>'; });
                html += '</div></div>';
            }

            if (bools.length) {
                html += '<div class="sm-type-group"><div class="sm-type-hd">布尔值 <span class="sm-type-badge">' + bools.length + '</span></div>';
                bools.forEach(b => {
                    html += '<div class="icard"><div class="sw-row"><span class="icard-label" style="margin:0">' + b.name +
                        '</span><label class="sw"><input type="checkbox" data-bool="' + b.name + '"' +
                        (b.value ? ' checked' : '') + '><span class="sw-track"></span></label></div></div>';
                });
                html += '</div>';
            }

            if (nums.length) {
                html += '<div class="sm-type-group"><div class="sm-type-hd">数值 <span class="sm-type-badge">' + nums.length + '</span></div>';
                nums.forEach(n => {
                    html += '<div class="icard"><label class="icard-label">' + n.name +
                        '</label><input type="number" class="ninput" data-num="' + n.name + '" value="' + (n.value || 0) + '" step="any"></div>';
                });
                html += '</div>';
            }

            box.innerHTML = html;

            // Bind events
            box.querySelectorAll('.trigger-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const inp = inputs.find(i => i.name === btn.dataset.trg);
                    if (inp) { inp.fire(); console.log('[Rive] SM trigger fired:', btn.dataset.trg); }
                    else console.warn('[Rive] SM trigger not found:', btn.dataset.trg);
                });
            });
            box.querySelectorAll('[data-bool]').forEach(el => {
                el.addEventListener('change', function () {
                    const inp = inputs.find(i => i.name === this.dataset.bool);
                    if (inp) { inp.value = this.checked; console.log('[Rive] SM bool set:', this.dataset.bool, '=', this.checked); }
                    else console.warn('[Rive] SM bool not found:', this.dataset.bool);
                });
            });
            box.querySelectorAll('[data-num]').forEach(el => {
                el.addEventListener('input', function () {
                    const inp = inputs.find(i => i.name === this.dataset.num);
                    if (inp) { inp.value = parseFloat(this.value) || 0; console.log('[Rive] SM num set:', this.dataset.num, '=', parseFloat(this.value) || 0); }
                    else console.warn('[Rive] SM num not found:', this.dataset.num);
                });
            });
        }

        function playSM(name) {
            if (curAnim) { try { R.stop(curAnim); } catch (e) {} curAnim = null; }
            if (curSM && curSM !== name) { try { R.stop(curSM); } catch (e) {} }
            curSM = name;
            R.play(name);
            playing = true; updatePlayIcon();
        }

        function playAnim(name) {
            if (curSM) { try { R.stop(curSM); } catch (e) {} }
            if (name) { R.play(name); playing = true; updatePlayIcon(); }
        }

        /* ====== ViewModel ====== */
        let currentVMI = null;

        function escapeAttr(s) { return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

        function riveColorToHex(c) {
            var n = (c < 0 ? c + 0x100000000 : c) >>> 0;
            var r = (n >> 16) & 0xFF, g = (n >> 8) & 0xFF, b = n & 0xFF;
            return '#' + ((1 << 24) | (r << 16) | (g << 8) | b).toString(16).slice(1);
        }

        function hexToRiveColor(hex) {
            hex = hex.replace('#', '');
            var n = parseInt(hex, 16);
            return (0xFF000000 | n) >>> 0;
        }

        // WASM DataType 枚举数值
        var DT = { none: 0, string: 1, number: 2, boolean: 3, color: 4, list: 5, enumType: 6, trigger: 7, viewModel: 8 };
        // 高层 PropertyType 字符串枚举
        var PT = { number: 'number', string: 'string', boolean: 'boolean', color: 'color', trigger: 'trigger', enum: 'enum', list: 'list', image: 'image', artboard: 'artboard' };

        /**
         * 将属性类型标准化为统一的字符串类别
         * 同时支持 WASM 数字枚举 和 高层 API 字符串枚举
         */
        function normalizeType(t) {
            if (typeof t === 'number') {
                switch (t) {
                    case DT.trigger: return 'trigger';
                    case DT.boolean: return 'boolean';
                    case DT.number: return 'number';
                    case DT.string: return 'string';
                    case DT.color: return 'color';
                    case DT.list: return 'list';
                    case DT.enumType: return 'enum';
                    case DT.viewModel: return 'viewModel';
                    default: return 'unknown-' + t;
                }
            }
            if (typeof t === 'string') {
                var s = t.toLowerCase();
                if (s === 'enum' || s === 'enumtype') return 'enum';
                if (s === 'viewmodel') return 'viewModel';
                return s;
            }
            return 'unknown';
        }

        /**
         * 获取属性描述列表，多层回退策略：
         * 1. VMI.properties（ViewModelInstance getter）
         * 2. ViewModel.properties（通过 ViewModel 对象获取）
         * 3. try-catch 探测（最后手段）
         */
        function getPropertyDescriptors(vmi, vmName) {
            var props = [];

            // 策略 1：直接从 ViewModelInstance 获取
            try { props = vmi.properties; } catch (e) { console.warn('[Rive] vmi.properties failed:', e); }
            if (props && props.length) {
                console.log('[Rive] 属性来源: vmi.properties, 数量:', props.length,
                    props.map(function(p) { return p.name + ':' + p.type + '(' + typeof p.type + ')'; }));
                return props;
            }

            // 策略 2：从 ViewModel 对象获取
            try {
                var vm = null;
                if (vmName) {
                    try { vm = R.viewModelByName(vmName); } catch (e2) {}
                }
                if (!vm) {
                    try { vm = R.defaultViewModel(); } catch (e2) {}
                }
                if (vm) {
                    try { props = vm.properties; } catch (e2) {}
                    if (props && props.length) {
                        console.log('[Rive] 属性来源: vm.properties, 数量:', props.length,
                            props.map(function(p) { return p.name + ':' + p.type + '(' + typeof p.type + ')'; }));
                        return props;
                    }
                }
            } catch (e) { console.warn('[Rive] vm.properties failed:', e); }

            // 策略 3：try-catch 探测每种类型
            console.log('[Rive] 回退到 try-catch 探测');
            var probed = [];
            var accessors = [
                { method: 'trigger',   type: 'trigger' },
                { method: 'boolean',   type: 'boolean' },
                { method: 'number',    type: 'number' },
                { method: 'string',    type: 'string' },
                { method: 'color',     type: 'color' },
                { method: 'enum',      type: 'enum' },
                { method: 'list',      type: 'list' },
                { method: 'viewModel', type: 'viewModel' },
            ];

            // 尝试通过已知属性名探测
            // 如果有 WASM runtime，先尝试获取原始属性列表
            try {
                var rt = vmi._runtimeInstance || vmi.runtimeInstance || vmi.nativeInstance;
                if (rt && typeof rt.getProperties === 'function') {
                    var raw = rt.getProperties();
                    if (raw && raw.length) {
                        console.log('[Rive] 属性来源: runtime.getProperties(), 数量:', raw.length,
                            Array.prototype.map.call(raw, function(p) { return p.name + ':' + p.type + '(' + typeof p.type + ')'; }));
                        return Array.prototype.map.call(raw, function(p) { return { name: p.name, type: p.type }; });
                    }
                }
            } catch (e) { console.warn('[Rive] runtime.getProperties failed:', e); }

            return probed;
        }

        function populateViewModel() {
            var sel = document.getElementById('vmSelect');
            var box = document.getElementById('vmProps');
            var vmSection = document.getElementById('vmSection');
            box.innerHTML = '';
            currentVMI = null;

            function hideVM() {
                vmSection.style.display = 'none';
            }

            if (!R) { sel.innerHTML = '<option value="">无视图模型</option>'; hideVM(); return; }

            var count = 0;
            try { count = R.viewModelCount || 0; } catch (e) { console.warn('[Rive] viewModelCount error:', e); }
            console.log('[Rive] viewModelCount:', count);

            // 检查 autoBind 绑定的默认实例
            var autoVMI = null;
            try { autoVMI = R.viewModelInstance; } catch (e) {}
            console.log('[Rive] autoBind viewModelInstance:', autoVMI ? '已绑定' : '未绑定');

            // 如果没有通过 viewModelCount 检测到，但有 autoBind 实例，也显示数据区
            if (!count && !autoVMI) {
                sel.innerHTML = '<option value="">无视图模型</option>';
                hideVM();
                return;
            }

            vmSection.style.display = '';

            // 获取 ViewModel 名称列表
            var vmInfos = []; // [{name, index}]
            for (var i = 0; i < count; i++) {
                try {
                    var vm = R.viewModelByIndex(i);
                    var name = vm && vm.name ? vm.name : '视图模型 ' + i;
                    console.log('[Rive] viewModelByIndex(' + i + '):', name, vm ? '有效' : '无效');
                    vmInfos.push({ name: name, index: i });
                } catch (e) {
                    console.warn('[Rive] viewModelByIndex(' + i + ') error:', e);
                    vmInfos.push({ name: '视图模型 ' + i, index: i });
                }
            }

            // 如果 count=0 但有 autoVMI，使用 defaultViewModel 获取名称
            if (!vmInfos.length && autoVMI) {
                var defName = '默认视图模型';
                try {
                    var defVM = R.defaultViewModel();
                    if (defVM && defVM.name) defName = defVM.name;
                } catch (e) {}
                vmInfos.push({ name: defName, index: -1 });
            }

            sel.innerHTML = vmInfos.map(function (info) {
                return '<option value="' + escapeAttr(info.name) + '" data-idx="' + info.index + '">' + escapeAttr(info.name) + '</option>';
            }).join('');

            sel.onchange = function () {
                if (sel.value) loadVMProperties(sel.value);
            };
            if (vmInfos.length) loadVMProperties(vmInfos[0].name);
        }

        function loadVMProperties(vmName) {
            var box = document.getElementById('vmProps');
            box.innerHTML = '';
            currentVMI = null;

            try {
                var vmi = null;

                // 策略 1：使用 autoBind 绑定的默认实例
                try { vmi = R.viewModelInstance; } catch (e) { console.warn('[Rive] R.viewModelInstance error:', e); }

                // 策略 2：通过名称获取 ViewModel → defaultInstance → bind
                if (!vmi) {
                    console.log('[Rive] autoBind 未获取到实例，尝试手动实例化');
                    var vm = null;
                    try { vm = R.viewModelByName(vmName); } catch (e) {}
                    if (!vm) { try { vm = R.defaultViewModel(); } catch (e) {} }
                    if (vm) {
                        console.log('[Rive] 获取到 ViewModel:', vm.name || vmName);
                        var inst = null;
                        try { inst = vm.defaultInstance(); } catch (e) { console.warn('[Rive] vm.defaultInstance() failed:', e); }
                        if (!inst) {
                            try { inst = vm.instance(); } catch (e) { console.warn('[Rive] vm.instance() failed:', e); }
                        }
                        if (inst) {
                            try { R.bindViewModelInstance(inst); } catch (e) { console.warn('[Rive] bindViewModelInstance failed:', e); }
                            vmi = inst;
                        }
                    }
                }

                console.log('[Rive] loadVMProperties:', vmName, '| vmi:', vmi ? '有实例' : '无实例');
                if (vmi) {
                    console.log('[Rive] vmi 类型:', typeof vmi, '| 构造函数:', vmi.constructor && vmi.constructor.name);
                    console.log('[Rive] vmi 方法:', ['properties', 'number', 'string', 'boolean', 'color', 'trigger', 'enum', 'list', 'viewModel'].filter(function(m) { return typeof vmi[m] !== 'undefined' || typeof vmi[m] === 'function'; }));
                    try {
                        var testProps = vmi.properties;
                        console.log('[Rive] vmi.properties 直接测试:', testProps ? ('length=' + testProps.length) : 'null/undefined',
                            testProps && testProps.length ? JSON.stringify(testProps.slice(0, 5).map(function(p) { return { name: p.name, type: p.type, typeOf: typeof p.type }; })) : '');
                    } catch (e) { console.error('[Rive] vmi.properties 测试失败:', e); }
                }

                if (!vmi) {
                    box.innerHTML = '<div class="empty">无法加载视图模型实例</div>';
                    return;
                }

                currentVMI = vmi;
                renderVMProperties(vmi, vmName, box, 0);
            } catch (e) {
                console.error('[Rive] loadVMProperties error:', e);
                box.innerHTML = '<div class="empty">错误：' + escapeAttr(e.message || e) + '</div>';
            }
        }

        /**
         * 渲染 ViewModel 属性（支持递归展示嵌套 ViewModel）
         * @param {object} vmi - ViewModelInstance
         * @param {string} vmName - ViewModel 名称
         * @param {HTMLElement} container - 渲染目标容器
         * @param {number} depth - 嵌套深度（0=顶层）
         */
        function renderVMProperties(vmi, vmName, container, depth) {
            var propDescs = getPropertyDescriptors(vmi, depth === 0 ? vmName : null);
            console.log('[Rive] renderVMProperties:', vmName, '| depth:', depth, '| props:', propDescs.length,
                propDescs.map(function(p) { return p.name + ':' + p.type + '→' + normalizeType(p.type); }));

            if (!propDescs.length) {
                container.innerHTML += '<div class="empty">暂无属性</div>';
                return;
            }

            // 按类型分组
            var groups = {
                triggers: [], bools: [], nums: [], strs: [],
                colors: [], enums: [], lists: [], viewModels: []
            };

            for (var idx = 0; idx < propDescs.length; idx++) {
                var pd = propDescs[idx];
                var pname = pd.name;
                var ptype = normalizeType(pd.type);

                switch (ptype) {
                    case 'trigger':
                        try { var t = vmi.trigger(pname); if (t) groups.triggers.push({ name: pname, acc: t }); } catch (e) { console.warn('[Rive] trigger accessor failed:', pname, e); }
                        break;
                    case 'boolean':
                        try { var b = vmi.boolean(pname); if (b) groups.bools.push({ name: pname, acc: b }); } catch (e) { console.warn('[Rive] boolean accessor failed:', pname, e); }
                        break;
                    case 'number':
                        try { var n = vmi.number(pname); if (n) groups.nums.push({ name: pname, acc: n }); } catch (e) { console.warn('[Rive] number accessor failed:', pname, e); }
                        break;
                    case 'string':
                        try { var s = vmi.string(pname); if (s) groups.strs.push({ name: pname, acc: s }); } catch (e) { console.warn('[Rive] string accessor failed:', pname, e); }
                        break;
                    case 'color':
                        try { var c = vmi.color(pname); if (c) groups.colors.push({ name: pname, acc: c }); } catch (e) { console.warn('[Rive] color accessor failed:', pname, e); }
                        break;
                    case 'enum':
                        try { var en = vmi.enum(pname); if (en) groups.enums.push({ name: pname, acc: en }); } catch (e) { console.warn('[Rive] enum accessor failed:', pname, e); }
                        break;
                    case 'list':
                        try { var l = vmi.list(pname); if (l) groups.lists.push({ name: pname, acc: l }); } catch (e) { console.warn('[Rive] list accessor failed:', pname, e); }
                        break;
                    case 'viewModel':
                        try { var vmChild = vmi.viewModel(pname); if (vmChild) groups.viewModels.push({ name: pname, acc: vmChild }); } catch (e) { console.warn('[Rive] viewModel accessor failed:', pname, e); }
                        break;
                    default:
                        console.warn('[Rive] 未知属性类型:', pname, 'type=', pd.type, 'normalized=', ptype);
                        break;
                }
            }

            var html = '';
            var prefix = depth > 0 ? 'd' + depth + '-' : '';

            if (groups.triggers.length) {
                html += '<div class="sm-type-group"><div class="sm-type-hd">触发器 <span class="sm-type-badge">' + groups.triggers.length + '</span></div><div class="trigger-grid">';
                groups.triggers.forEach(function (t) {
                    html += '<button class="trigger-btn" data-vm-trg="' + escapeAttr(t.name) + '">' + escapeAttr(t.name) + '</button>';
                });
                html += '</div></div>';
            }

            if (groups.bools.length) {
                html += '<div class="sm-type-group"><div class="sm-type-hd">布尔值 <span class="sm-type-badge">' + groups.bools.length + '</span></div>';
                groups.bools.forEach(function (b) {
                    var val = false;
                    try { val = b.acc.value; } catch (e) {}
                    html += '<div class="icard"><div class="sw-row"><span class="icard-label" style="margin:0">' + escapeAttr(b.name) +
                        '</span><label class="sw"><input type="checkbox" data-vm-bool="' + escapeAttr(b.name) + '"' +
                        (val ? ' checked' : '') + '><span class="sw-track"></span></label></div></div>';
                });
                html += '</div>';
            }

            if (groups.nums.length) {
                html += '<div class="sm-type-group"><div class="sm-type-hd">数值 <span class="sm-type-badge">' + groups.nums.length + '</span></div>';
                groups.nums.forEach(function (n) {
                    var val = 0;
                    try { val = n.acc.value; } catch (e) {}
                    html += '<div class="icard"><label class="icard-label">' + escapeAttr(n.name) +
                        '</label><input type="number" class="ninput" data-vm-num="' + escapeAttr(n.name) + '" value="' + val + '" step="any"></div>';
                });
                html += '</div>';
            }

            if (groups.strs.length) {
                html += '<div class="sm-type-group"><div class="sm-type-hd">字符串 <span class="sm-type-badge">' + groups.strs.length + '</span></div>';
                groups.strs.forEach(function (s) {
                    var val = '';
                    try { val = s.acc.value || ''; } catch (e) {}
                    html += '<div class="icard"><label class="icard-label">' + escapeAttr(s.name) +
                        '</label><input type="text" class="sinput" data-vm-str="' + escapeAttr(s.name) + '" value="' + escapeAttr(val) + '"></div>';
                });
                html += '</div>';
            }

            if (groups.colors.length) {
                html += '<div class="sm-type-group"><div class="sm-type-hd">颜色 <span class="sm-type-badge">' + groups.colors.length + '</span></div>';
                groups.colors.forEach(function (c) {
                    var val = 0xFF000000;
                    try { val = c.acc.value; } catch (e) {}
                    var hex = riveColorToHex(val);
                    html += '<div class="icard"><label class="icard-label">' + escapeAttr(c.name) + '</label>' +
                        '<div class="color-row">' +
                        '<div class="color-swatch" style="background:' + hex + '" data-vm-cswatch="' + escapeAttr(c.name) + '">' +
                        '<input type="color" data-vm-color="' + escapeAttr(c.name) + '" value="' + hex + '">' +
                        '</div>' +
                        '<span class="color-hex" data-vm-chex="' + escapeAttr(c.name) + '">' + hex.toUpperCase() + '</span>' +
                        '</div></div>';
                });
                html += '</div>';
            }

            if (groups.enums.length) {
                html += '<div class="sm-type-group"><div class="sm-type-hd">枚举 <span class="sm-type-badge">' + groups.enums.length + '</span></div>';
                groups.enums.forEach(function (en) {
                    var val = '';
                    var options = [];
                    try { val = en.acc.value || ''; } catch (e) {}
                    try { options = en.acc.values || []; } catch (e) {}
                    html += '<div class="icard"><label class="icard-label">' + escapeAttr(en.name) + '</label>';
                    if (options.length) {
                        html += '<select class="sel" data-vm-enum="' + escapeAttr(en.name) + '">';
                        options.forEach(function (opt) {
                            html += '<option value="' + escapeAttr(opt) + '"' + (opt === val ? ' selected' : '') + '>' + escapeAttr(opt) + '</option>';
                        });
                        html += '</select>';
                    } else {
                        html += '<input type="text" class="sinput" data-vm-enum="' + escapeAttr(en.name) + '" value="' + escapeAttr(val) + '">';
                    }
                    html += '</div>';
                });
                html += '</div>';
            }

            if (groups.lists.length) {
                html += '<div class="sm-type-group"><div class="sm-type-hd">列表 <span class="sm-type-badge">' + groups.lists.length + '</span></div>';
                groups.lists.forEach(function (l) {
                    var size = 0;
                    try { size = l.acc.size || 0; } catch (e) {}
                    html += '<div class="icard"><span class="icard-label">' + escapeAttr(l.name) +
                        '</span><span class="info-value" style="font-size:13px">' + size + ' 项</span></div>';
                });
                html += '</div>';
            }

            if (groups.viewModels.length) {
                html += '<div class="sm-type-group"><div class="sm-type-hd">嵌套视图模型 <span class="sm-type-badge">' + groups.viewModels.length + '</span></div>';
                groups.viewModels.forEach(function (vm) {
                    var childCount = 0;
                    try { childCount = vm.acc.properties ? vm.acc.properties.length : 0; } catch (e) {}
                    html += '<div class="icard"><span class="icard-label">' + escapeAttr(vm.name) +
                        '</span><span class="info-value" style="font-size:13px">' + childCount + ' 个属性</span>';
                    html += '<div class="vm-nested" data-vm-nested="' + escapeAttr(vm.name) + '"></div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            if (!html) {
                container.innerHTML += '<div class="empty">暂无支持的属性</div>';
                return;
            }

            container.innerHTML = html;
            bindVMEvents(vmi, container);

            // 递归渲染嵌套 ViewModel（最多 3 层）
            if (depth < 3) {
                groups.viewModels.forEach(function (vm) {
                    var nestedContainer = container.querySelector('[data-vm-nested="' + vm.name + '"]');
                    if (nestedContainer && vm.acc) {
                        renderVMProperties(vm.acc, vm.name, nestedContainer, depth + 1);
                    }
                });
            }
        }

        function bindVMEvents(vmi, box) {
            // Triggers
            box.querySelectorAll('[data-vm-trg]').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    try {
                        var t = vmi.trigger(btn.dataset.vmTrg);
                        if (t) { t.trigger ? t.trigger() : (t.fire ? t.fire() : null); }
                    } catch (e) { console.warn('[Rive] VM trigger error:', btn.dataset.vmTrg, e); }
                });
            });
            // Booleans
            box.querySelectorAll('[data-vm-bool]').forEach(function (el) {
                el.addEventListener('change', function () {
                    try { var b = vmi.boolean(el.dataset.vmBool); if (b) b.value = el.checked; } catch (e) { console.warn('[Rive] VM boolean error:', el.dataset.vmBool, e); }
                });
            });
            // Numbers
            box.querySelectorAll('[data-vm-num]').forEach(function (el) {
                el.addEventListener('input', function () {
                    try { var n = vmi.number(el.dataset.vmNum); if (n) n.value = parseFloat(el.value) || 0; } catch (e) { console.warn('[Rive] VM number error:', el.dataset.vmNum, e); }
                });
            });
            // Strings
            box.querySelectorAll('[data-vm-str]').forEach(function (el) {
                el.addEventListener('input', function () {
                    try { var s = vmi.string(el.dataset.vmStr); if (s) s.value = el.value; } catch (e) { console.warn('[Rive] VM string error:', el.dataset.vmStr, e); }
                });
            });
            // Colors
            box.querySelectorAll('[data-vm-color]').forEach(function (el) {
                el.addEventListener('input', function () {
                    var name = el.dataset.vmColor;
                    try {
                        var c = vmi.color(name);
                        if (c) c.value = hexToRiveColor(el.value);
                    } catch (e) { console.warn('[Rive] VM color error:', name, e); }
                    var swatch = box.querySelector('[data-vm-cswatch="' + name + '"]');
                    if (swatch) swatch.style.background = el.value;
                    var hexLabel = box.querySelector('[data-vm-chex="' + name + '"]');
                    if (hexLabel) hexLabel.textContent = el.value.toUpperCase();
                });
            });
            // Enums (支持 select 和 input 两种元素)
            box.querySelectorAll('[data-vm-enum]').forEach(function (el) {
                var evtName = el.tagName === 'SELECT' ? 'change' : 'input';
                el.addEventListener(evtName, function () {
                    try { var en = vmi.enum(el.dataset.vmEnum); if (en) en.value = el.value; } catch (e) { console.warn('[Rive] VM enum error:', el.dataset.vmEnum, e); }
                });
            });
        }

        /* ====== Playback Controls ====== */
        btnPlay.addEventListener('click', () => {
            if (!R) return;
            if (playing) {
                R.pause();
            } else {
                // 恢复当前模式下的播放目标
                curSM ? R.play(curSM) : (curAnim ? R.play(curAnim) : R.play());
            }
            playing = !playing;
            updatePlayIcon();
        });
        btnRestart.addEventListener('click', () => {
            if (!R) return;
            R.reset();
            if (curSM) {
                R.play(curSM);
                requestAnimationFrame(() => requestAnimationFrame(() => loadSMInputs(curSM)));
            } else if (curAnim) {
                R.play(curAnim);
            } else {
                R.play();
            }
            playing = true; updatePlayIcon();
        });

        /* ====== Keyboard ====== */
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            if (e.code === 'Space') { e.preventDefault(); btnPlay.click(); }
            else if (e.code === 'KeyR') btnRestart.click();
        });

        /* ====== Resize ====== */
        let rT;
        window.addEventListener('resize', () => { clearTimeout(rT); rT = setTimeout(fitCanvas, 80); });

        /* ====== Cleanup ====== */
        window.addEventListener('beforeunload', () => { if (R) R.cleanup(); });

        /* ====== Start ====== */
        initRive();
    })();
    </script>
</body>
</html>
